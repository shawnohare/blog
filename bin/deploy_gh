#!/usr/bin/env bash
set -ex

readonly gh="https://github.com/shawnohare"
readonly rev=$(git rev-parse HEAD)

# Sync git with generated site to avoid pushing
if [ !  -d public ]; then
  git clone "${gh}/shawnohare.github.io" public
fi
cd public && rm -rf $(ls) && cd ..
hugo && cd public

#  Check if there are any changes. If so commit and override the last
# non-initial commit. Requires at least one previous non-initial commit.
if [ ! -z "$(git status --porcelain)" ]; then
  git add --all
  # Uncomment to allow squashing with previous commits.
  git commit -m "tmp"
  git reset --soft HEAD~2
  git commit -m "Generated from shawnohare.com ${rev}"
  git push origin master --force
else
  echo "Nothing to sync."
fi

# Simple version that pushes excess files. Site repo has a single commit.
# rm -rf public
# hugo
# cd public
# git init
# git remote add origin "${gh}/shawnohare.github.io"
# git add --all
# git commit -m "Generated from shawnohare.com ${rev}"
# git push -f --set-upstream origin master
